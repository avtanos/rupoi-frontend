# Матрица комбинаций выборок для жизненного цикла РУПОИ

## Реализованные компоненты

### 1. Опорные справочники (`src/constants/reference-dictionaries.ts`)

#### Справочники и их коды:
- **Стороны**: `LEFT`, `RIGHT`, `BOTH`
- **Срочность**: `NORMAL`, `URGENT`
- **Типы услуг**: `PROSTHESIS`, `SHOES`, `OTTO`, `REPAIR`
- **Группы инвалидности**: `GROUP_I`, `GROUP_II`, `GROUP_III`
- **Категории инвалидности**: `CHILD`, `SINCE_CHILDHOOD`, `VOV`, `LABOUR`, `OTHER`
- **Причины инвалидности**: `TRAUMA`, `CONGENITAL`, `DISEASE`, `OTHER`
- **Типы диагнозов**: МКБ-10 коды (`S78.1`, `Q72.0`, и т.д.)
- **Статусы заказов**: `0-7` (НЕАКТИВНЫЙ → ВЫДАН)
- **Статусы накладных**: `NEW`, `SENT`, `PROCESSED`

### 2. Переходы жизненного цикла (`src/constants/lifecycle-transitions.ts`)

#### Карточка пациента (cart) — жизненный цикл:

| № | Переход | Обязательные поля | Допустимые комбинации | Условия | Источник/кнопка |
|---|---------|-------------------|----------------------|---------|-----------------|
| C1 | DRAFT → ACTIVE | `first_name`, `name`, `birth_date`, `document_type`, `document_series`, `document_number`, `registration_address` | `disability_group` × `disability_category` × `disability_reason` | ФИО, ДР, Документ, Адрес заполнены; при наличии инвалидности — `from_date ≤ today` | `/create` → «Сохранить» |
| C2 | ACTIVE → REFERRED_MED | `service_type` | `service_type` ∈ {PROSTHESIS, SHOES, OTTO, REPAIR} | Карточка Active; есть минимум 1 диагноз или инвалидность | `/cart/info/:id` → «Направить» |
| C3 | ACTIVE → ARCHIVED | `deregistration_reason`, `deregistration_date` | — | Указана причина снятия, дата снятия ≤ today | `/cart/info/:id` → «Архивировать» |
| C4 | ARCHIVED → ACTIVE | `restoration_reason`, `restoration_date` | — | Разархивирование с протоколом | `/archive/list` → «Восстановить» |

#### Заказ (order) — жизненный цикл:

| № | Переход | Обязательные поля | Допустимые комбинации | Условия | Источник/кнопка |
|---|---------|-------------------|----------------------|---------|-----------------|
| O1 | NEW → NAPRAVLEN_V_PROIZV | `service_type`, `diagnosis_type_id` | `service_type` × `diagnosis_type_id` | Заказ новый, привязка к карточке | `/order/create` → «Создать заказ» |
| O2 | NAPRAVLEN_V_PROIZV → V_PROIZV | `assigned_workshop_id`, `planned_start_date` | — | Назначена мастерская, планируемая дата | `/order/info/:id` → «Начать производство» |
| O3 | V_PROIZV → NA_PRIMERKE | `measurements_completed` | — | Измерения завершены, материалы назначены | `/order/info/:id` → «Отправить на примерку» |
| O4 | NA_PRIMERKE → NA_SKLADE | `fitting_completed` | — | Примерка завершена, контроль качества пройден | `/order/info/:id` → «Передать на склад» |
| O5 | NA_SKLADE → VIDAN | `issue_date`, `issued_to_patient` | — | Дата выдачи, подтверждение выдачи | `/warehouse/issue` → «Выдать пациенту» |
| O6 | NEW → NA_UTVERZHDENII | `medical_approval_required` | — | Требуется медицинское одобрение | `/order/info/:id` → «Направить на утверждение» |

#### Накладная (overhead) — жизненный цикл:

| № | Переход | Обязательные поля | Допустимые комбинации | Условия | Источник/кнопка |
|---|---------|-------------------|----------------------|---------|-----------------|
| H1 | NEW → SENT | `order_ids`, `recipient_workshop_id` | — | Добавлены заказы, указан получатель | `/overheads/create` → «Передать» |
| H2 | SENT → PROCESSED | `processing_date`, `processed_by` | — | Дата обработки, обработавший сотрудник | `/overheads/process` → «Обработать» |

### 3. SQL-шаблоны для выборок (`src/constants/sql-templates.ts`)

#### Шаблоны для карточек пациентов:

| ID | Название | Описание | Параметры |
|----|----------|----------|-----------|
| `CART_ACTIVE` | Активные карточки пациентов | Выборка всех активных карточек | — |
| `CART_ARCHIVED` | Архивные карточки пациентов | Выборка всех архивных карточек | — |
| `CART_REFERRED_MED` | Карточки направленные в медотдел | Выборка карточек направленных в медицинский отдел | — |
| `CART_BY_DISABILITY_GROUP` | Карточки по группе инвалидности | Выборка карточек по группе инвалидности | `disability_group` (string) |
| `CART_BY_AGE_RANGE` | Карточки по возрастному диапазону | Выборка карточек по возрастному диапазону | `min_age` (number), `max_age` (number) |

#### Шаблоны для заказов:

| ID | Название | Описание | Параметры |
|----|----------|----------|-----------|
| `ORDER_BY_STATUS` | Заказы по статусу | Выборка заказов по статусу | `status` (string) |
| `ORDER_URGENT` | Срочные заказы | Выборка всех срочных заказов | — |
| `ORDER_BY_TYPE` | Заказы по типу | Выборка заказов по типу услуги | `order_type` (string) |
| `ORDER_IN_PROGRESS` | Заказы в производстве | Выборка заказов в производстве с назначенными сотрудниками | — |
| `ORDER_READY_FOR_ISSUE` | Заказы готовые к выдаче | Выборка заказов готовых к выдаче | — |

#### Шаблоны для накладных:

| ID | Название | Описание | Параметры |
|----|----------|----------|-----------|
| `OVERHEAD_BY_STATUS` | Накладные по статусу | Выборка накладных по статусу | `status` (string) |
| `OVERHEAD_PENDING` | Накладные ожидающие обработки | Выборка накладных ожидающих обработки | — |

### 4. Система валидации (`src/lib/lifecycle-validator.ts`)

#### Функциональность:
- **Валидация переходов** - проверка условий и обязательных полей
- **Проверка комбинаций** - валидация допустимых значений
- **Утилиты валидации** - проверка возможности перехода, получение доступных переходов
- **Специальные валидаторы** - для дат, ФИО, документов, адресов

#### Типы валидации:
- `eq` - равно
- `ne` - не равно
- `gt` - больше
- `lt` - меньше
- `gte` - больше или равно
- `lte` - меньше или равно
- `in` - входит в список
- `nin` - не входит в список
- `exists` - существует
- `not_exists` - не существует

### 5. Компоненты управления (`src/components/`)

#### LifecycleTransitionManager
- **Управление переходами** - отображение доступных и недоступных переходов
- **Валидация в реальном времени** - проверка условий перед переходом
- **Подтверждение переходов** - модальные окна с детальной информацией
- **Визуализация статусов** - цветовая индикация состояний

#### SQLTemplateManager
- **Выбор шаблонов** - фильтрация по типу сущности
- **Параметризация** - ввод параметров для SQL-запросов
- **Генерация SQL** - автоматическое построение запросов
- **Валидация параметров** - проверка корректности введенных данных
- **Экспорт SQL** - копирование и скачивание сгенерированных запросов

## Примеры использования

### 1. Переход карточки из DRAFT в ACTIVE

```typescript
// Данные карточки
const cartData = {
  first_name: 'Иван',
  name: 'Иванов',
  parent_name: 'Иванович',
  birth_date: '1980-05-15',
  document_type: 'PASSPORT',
  document_series: 'AB1234',
  document_number: '123456',
  registration_address: 'г. Бишкек, ул. Ленина, 1',
  disability_group: 'GROUP_II',
  disability_category: 'LABOUR',
  disability_reason: 'TRAUMA',
  disability_from_date: '2020-01-15'
};

// Валидация перехода
const validator = new LifecycleValidator(cartData);
const transition = getTransitionById(CART_LIFECYCLE_TRANSITIONS, 'C1');
const result = validator.validateTransition(transition);

if (result.isValid) {
  // Переход разрешен
  console.log('Карточка может быть активирована');
} else {
  // Показать ошибки
  console.log('Ошибки:', result.errors);
}
```

### 2. Генерация SQL для выборки активных карточек

```typescript
// Выбор шаблона
const template = getTemplateById('CART_ACTIVE');

// Генерация SQL
const sql = buildSQL(template, {});

// Результат:
// SELECT c.id, c.card_number, c.first_name, c.name, c.parent_name, ...
// FROM carts c
// LEFT JOIN oblasts o ON c.registration_oblast_id = o.id
// WHERE c.status = 'ACTIVE'
// ORDER BY c.created_at DESC
```

### 3. Выборка заказов по статусу

```typescript
// Параметры запроса
const parameters = {
  status: 'V_PROIZV'
};

// Валидация параметров
const template = getTemplateById('ORDER_BY_STATUS');
const validation = validateParameters(template, parameters);

if (validation.isValid) {
  const sql = buildSQL(template, parameters);
  // Выполнение запроса...
}
```

## Интеграция с существующей системой

### 1. Обновление типов данных
- Добавлены новые поля в интерфейсы `Cart`, `Order`, `Overhead`
- Расширены справочники в `dictionaries.json`
- Обновлены константы статусов

### 2. API методы
- `validateTransition()` - валидация переходов
- `getAvailableTransitions()` - получение доступных переходов
- `executeSQL()` - выполнение SQL-запросов
- `buildSQL()` - генерация SQL из шаблонов

### 3. UI компоненты
- Интеграция в формы создания/редактирования
- Модальные окна для подтверждения переходов
- Панели управления SQL-шаблонами
- Индикаторы статусов и переходов

## Безопасность и производительность

### 1. Валидация на клиенте и сервере
- Двойная проверка всех переходов
- Защита от SQL-инъекций в шаблонах
- Валидация типов данных

### 2. Кэширование
- Кэширование справочников
- Кэширование результатов валидации
- Оптимизация SQL-запросов

### 3. Логирование
- Логирование всех переходов
- Аудит изменений статусов
- Отслеживание выполнения SQL-запросов

## Заключение

Реализована полная система матрицы комбинаций выборок для жизненного цикла РУПОИ, включающая:

- ✅ Опорные справочники с кодами и наименованиями
- ✅ Переходы жизненного цикла для всех сущностей
- ✅ SQL-шаблоны для выборок данных
- ✅ Систему валидации переходов
- ✅ UI компоненты для управления
- ✅ Интеграцию с существующей системой

Система готова к использованию и может быть легко расширена для новых типов сущностей и переходов.
